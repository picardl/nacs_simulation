function cbB_deperturbation


const = constants();


colors = {'r','b','k'};

Eoffs = const.h*((4*351725718500813 + 2*335116048808294)/6)/const.hartree;

cbB_file = 'data/cbB_220726_195840.mat';


cbB_data = load(cbB_file);

E = cbB_data.out.E + Eoffs;
nodes = cbB_data.out.nodes;
r = cbB_data.out.r;
qnums = cbB_data.out.qnums;
ops = cbB_data.out.ops;
psi = cbB_data.out.psi;
W_thy = cbB_data.out.W + Eoffs*eye(size(qnums,1));

N_pert = 40;
r_pert = unique([r(1:round(numel(r)/N_pert):end) r(end)]);
N_pert = numel(r_pert);


Wpert =@W_pert;
    function out = W_pert(r,X)
        
        X = reshape(X,[N_pert,6]);
        
        M = interp1(r_pert,X,r(:),'pchip','extrap');
        
        out(1,1,:) = M(:,1);
        out(2,2,:) = M(:,2);
        out(3,3,:) = M(:,3);
        out(1,2,:) = M(:,4);
        out(1,3,:) = M(:,5);
        out(2,3,:) = M(:,6);
        out = (out + permute(out,[2 1 3]))/2;
        
    end

R_test = 10;
ind_test = abs(r-R_test)==min(abs(r-R_test));
[V_thy,W_adiab_thy] = eigenshuffle(W_thy);
[~,ind_max] = max(abs(V_thy(:,:,ind_test)).^2,[],1);
W_adiab_thy = W_adiab_thy(ind_max,:);

% deltaW = W_tweak(r);

W_exp = W_emp(r);
W_adiab_exp = diag_nd(W_exp);

% rweight = [0 5.09 5.1 5.4 5.41 6.5 6.51 10 14 100]';
% wweight = [
%     0 0 0 0 1 1 1 1 1 1
%     0 0 0 0 0 0 1 1 1 1
%     0 0 1 1 1 1 1 1 1 1
%     ]';
% weight = interp1(rweight,wweight,r,'linear','extrap')';

% figure(2);
% plot(r,weight(r));

%% optimization
iter = 0;
    function [ssr,resid] = fun(X)
        [V_thy_new,W_thy_new] = eigenshuffle(W_thy + W_pert(r,X));
        [~,ind_max] = max(abs(V_thy_new(:,:,ind_test)).^2,[],1);
        W_thy_new = W_thy_new(ind_max,:);
%         resid = (W_adiab_exp - W_thy_new).*weight;
        resid = (W_adiab_exp - W_thy_new);
        ssr = sum(sum(resid.^2,1),2);
        
        if ~mod(iter,100)
            figure(1);
            clf;
            sp(1) = subplot(2,1,1);
            hold on
            box on
            for ii = 1:3
                plot(r,W_thy_new(ii,:),['-' colors{ii}])
                plot(r,W_adiab_exp(ii,:),['--' colors{ii}])
            end
            hold off
            ylim([-0.03 0.05]+Eoffs)
            set(gca,'xscale','log')
            
            sp(2) = subplot(2,1,2);
            plot(r,resid);
            set(gca,'xscale','log')
            linkaxes(sp,'x')
            
            disp(ssr)
        end
        iter = iter+1;
        
    end

% guess = zeros([N_pert,6]);
% guess(:,1) = 0.2*(r_pert/6.2).^(-8).*exp(-(r_pert/6.2).^8);
% guess = guess + 3e-3*randn(N_pert,6);

data = load('data/deperturbation_210706_150901.mat');
X = data.X;
X = reshape(X,[],6);

% X = [
%           1.12786554012535      -0.00668057477568137      -0.00158054233712365        0.0209265889757155      -0.00160186169455458      -0.00350660777381639
%            0.7855187588101      -0.00587893586089819      -0.00163394953080384        0.0162254934716202       0.00278493818611748      -0.00275065331713443
%          0.522239749210312      -0.00503879853900061       -0.0016415215337877       0.00925970808133722       0.00558773960937958      -0.00123423961958105
%          0.327716491816707      -0.00425164903176047      -0.00166322841869879       0.00289966461327492       0.00694969250533207     -2.31009826419084e-05
%          0.191235601849848      -0.00367792243956678      -0.00168275414708233      -0.00069831250651698       0.00710863266402643      0.000195411832057117
%          0.102080042586199      -0.00361144071153789      -0.00167742239747698       -0.0021070920491699       0.00697892486340297      0.000852948132438046
%         0.0493992513993352      -0.00368243726728392      -0.00166029716510099      -0.00438260111215348       0.00523733552644687       0.00214558096574203
%         0.0223707784053367      -0.00306625569526739      -0.00168247050330612      -0.00429108718802614       0.00308410231310617       0.00200335964849272
%         0.0111591226882372      -0.00248915760040246       -0.0016753916024633      -0.00141904634423497      0.000881521676369601      0.000161485886186857
%        0.00418207216511841      -0.00196481876843965      -0.00154178375311388     -0.000110959269557948      -0.00205396020635003     -0.000598934698669363
%         0.0013388978595981      -0.00201889850957089      -0.00150109936567084      0.000645681582261455      -0.00261867474202209     -3.47739901087649e-05
%       0.000511887563200502      -0.00238793347252467      -0.00138969678929819      0.000673714132806343      -0.00167244361741865       0.00328154835179803
%       0.000589023567511511      -0.00269037903845789       -0.0012017584608297      0.000210480007655207     -0.000130798183501879       0.00763160975866459
%        5.0814930091134e-05      -0.00215622529078488      -0.00101068477444564     -8.62228634019363e-05      0.000277801643168688       0.00815471261218882
%       4.29460045920223e-06       -0.0019652127368944      -0.00131485404592535     -0.000939524553959728     -0.000197651993871418       0.00628096997093199
%       1.55134024505906e-06      -0.00190631136136744      -0.00143933298912847      -0.00171196604296709      -0.00146712713178577       0.00287965228457687
%         5.343453352629e-07      -0.00183257847531255      -0.00142371221783882      -0.00220056112881809      -0.00229130080579578      -0.00035933219907261
%      -1.73713210036356e-09      -0.00157070749798508      -0.00141158063612165      -0.00221947781853078      -0.00101002183452336      -0.00125177391005993
%      -9.78938143126188e-10      -0.00156174791585327      -0.00124351027505612       -0.0023611172981147     -0.000703197126886128      -0.00250177821845593
%      -3.54169405850835e-10      -0.00172677517910811     -0.000919784970695371      -0.00238540107949043      -0.00029377186441089      -0.00405606000699014
%       1.75896629158566e-19      -0.00193092380111694     -0.000539961527429826      -0.00237526580464704      2.30943527606713e-05      -0.00516740084223837
%       9.23364478818144e-20      -0.00200681699274394      -0.00026492788537181       -0.0023552224350414      0.000121773187477013      -0.00511941004753331
%       4.10726567446624e-20      -0.00135584186879503     -0.000972731735959778      -0.00178180953245035       0.00046669838438873       -0.0029624138692165
%       1.22493893407064e-20     -0.000905243432086084      -0.00131172948678985      -0.00117852765384014      0.000798049424936014      -0.00162318798551506
%       5.73796538954354e-43     -0.000585783267267924      -0.00138119829437567     -0.000647567119499048      0.000640477018843978     -0.000700911602040342
%       -1.2217431526462e-06     -0.000369327097866046      -0.00119352425058482       -0.0002867782739672     -0.000117387098535443      1.24104976747126e-05
%      -9.87608674463476e-06     -0.000255251178822493      -0.00064744160280362     -0.000323150729034948     -0.000650310330288884      0.000661006675923903
%      -8.52874284188424e-05     -0.000131663545757452     -0.000332504647222245     -0.000182876779765288     -0.000424598548824596      0.000696390762935125
%      -0.000193032151864518     -3.69538911805383e-05     -1.81344157787215e-05     -1.71768074709946e-05      -0.00010503239756602       0.00107627618944014
%      -0.000266165596876899      1.52528787561548e-05      0.000261501962632233      0.000107017814804083      0.000101233490449106       0.00165829734882187
%      -0.000144744853149188      1.64077210291059e-05      0.000254667956636782      0.000108865221675927      7.85107551028198e-05       0.00137201428044705
%      -2.70875088100666e-05      3.31066608100743e-05      0.000165577369667414      7.70287492527378e-05      5.63439794082031e-05      0.000917235717590519
%       6.52021427690443e-05      3.13548300304408e-05      6.83100662610621e-05      5.09531843292869e-05      1.68083502517347e-05      0.000541124032766122
%       9.24720290931699e-05      3.00660301467018e-05     -3.05886060872373e-06      2.96371448008763e-05     -2.68598408815296e-05      0.000313964738132058
%      -1.13479976481678e-05      7.08582292769895e-05      2.66716604921384e-05      3.10381844134003e-06     -4.75357103616321e-05      0.000307738853302463
%      -0.000221932146643823      0.000183077935000592      6.74306816812317e-05     -3.07280981859587e-05     -9.43275883335719e-05      0.000395981683334633
%      -0.000324127934526732      0.000227085419807522      0.000103730324430513     -3.09513449620462e-05     -0.000112507806693903       0.00040637163569616
%      -0.000333300547692671      0.000217182141404322      0.000122294126244056     -1.01065757729225e-05     -0.000109307324726898      0.000360715495953318
%      -0.000226155389502376      0.000156692176736678      7.06015780689305e-05      1.54041633319078e-05     -9.04930985925079e-05      0.000268206902999893
%      -4.74821213358093e-05      8.61114153721647e-05     -1.73798135925826e-05       9.7067655910997e-05     -6.43423987624569e-05      1.09017288636627e-05
%     ];
% N_pert_old = size(X,1);
% r_pert_old = unique([r(1:round(numel(r)/N_pert_old):end) r(end)]);

% X = interp1(r_pert_old,X,r_pert);

X(14,4) = X(14,4) - 4e-4;
% X(9:10,2) = X(9:10,2) - 2e-5;

% [~,resid] = fun(X(:)');

% plot(r_pert,X(:,1:3),'.-',r,resid*20),set(gca,'xscale','log'),ylim([-0.01 0.01])


% X(14,4) = X(14,4) - 4e-4;

% X(2,1) = X(2,1) - 1e-4;

% X(r_pert<6.8,1:3) = X(r_pert<6.8,1:3) + interp1(r(r<6.8)',resid([2 1 3],r<6.8)',r_pert(r_pert<6.8));

fun(X(:)');

% X = fminsearch(@fun,X(:)',optimset('maxfuneval',inf,'maxiter',inf));

save(['data/deperturbation_' datestr(now,'YYmmDD_HHMMSS') '.mat'],'X','Wpert')

%%

% figure(1);
% clf;
% hold on
% box on
% for i = 1:3
%     plot(r,W_adiab_thy(i,:),['-' colors{i}])
%     plot(r,W_adiab_exp(i,:),['--' colors{i}])
% end
% hold off
% ylim([-0.03 0.005]+Eoffs)
% % set(gca,'xscale','log')

    function out = W_emp(r)
        r = reshape(r(:),1,1,[]);
        
        out = zeros(3,3,numel(r));
        
        out(1,1,:) = NaCscPES(r);
        out(2,2,:) = NaCsBPES(r);
        out(3,3,:) = NaCsbbPES(r);
    end


end