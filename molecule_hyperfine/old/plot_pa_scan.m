clear;

% name_files = {'names_20200629_002521','names_20200629_092621'}; % ,'names_20200629_081411','names_20200629_084559'};
% name_files = {'names_20200629_122605','names_20200629_124121'};
% name_files = {'names_20200629_193922'};
% name_files = {'names_20200629_201347'};
% name_files = {'names_20200629_215612'};

% name_files = {'names_20200630_083757'};
% name_files = {'names_20200630_112850'};
% name_files = {'names_20200701_000426'};
% name_files = {'names_20200709_133525'};

% name_files = {'names_20200716_083132'};
% name_files = {'names_20200716_104622','names_20200716_120746'};

% 7/16/2020:
% name_files = {'names_20200716_130018'};
% name_files = {'names_20200716_163218'};
% name_files = {'names_20200716_183134'};
% name_files = {'names_20200716_220057'};
% name_files = {'names_20200717_214055'}; %'names_20200717_074110', 'names_20200716_230329','names_20200717_002843','names_20200717_101127'
% name_files = {'names_20200718_000637','names_20200717_214055','names_20200718_093740','names_20200718_103832',...
%                 'names_20200718_124618','names_20200718_153536'};

% 7/19/2020
% name_files = {'names_20200719_132320'};
% name_files = {'names_20200719_140248'};
% name_files = {'names_20200719_162455','names_20200719_171749','names_20200719_235149','names_20200720_082603','names_20200720_120131'};
% name_files = {'names_20200720_225445','names_20200721_070213','names_20200721_095935'};
% name_files = {'names_20200721_162322','names_20200721_183521'};
% name_files = {'names_20200721_183521','names_20200722_012346'};
% name_files = {'names_20200722_094709','names_20200722_110724'};
% name_files = {'names_20200722_125824','names_20200719_162455','names_20200719_171749','names_20200719_235149','names_20200720_082603','names_20200720_174538','names_20200720_225445','names_20200721_070213','names_20200721_095935','names_20200721_183521','names_20200722_094709','names_20200722_110724'};

% name_files = {'names_20200627_172410'};
% name_files = {'names_20200626_091336','names_20200626_110612'};
% name_files = {'names_20200625_180711','names_20200625_195221'};
% name_files = {'names_20200625_121806'};
% name_files = {'names_20200625_121806','names_20200625_180711','names_20200625_195221','names_20200626_091336','names_20200626_110612'};

% name_files = {'names_20200804_210604'};
% name_files = {'names_20200806_021217','names_20200806_081559'};
% name_files = {'names_20200808_161058','names_20200808_175048'};
% % name_files = {'names_20200808_221400'};
% name_files = {'names_20200809_152749','names_20200809_201347','names_20200809_211613','names_20200810_102242'};
% % name_files = {'names_20200810_102242'};
% name_files = {'names_20200810_131025','names_20200810_134325'};
% name_files = {'names_20200810_151952','names_20200810_154747'};
% name_files = {'names_20200810_202321'};
% % name_files = {'names_20200810_234143','names_20200811_113507'};
% name_files = {'names_20200812_073147','names_20200812_080423'};
% name_files = {'names_20200812_083002'};
% name_files = {'names_20200815_124521','names_20200815_135855','names_20200815_150506'};
% % name_files = {'names_20200814_204347'};
% % name_files = {'names_20200815_155151'};
% % name_files = {'names_20200815_172853','names_20200815_165217'};
% % name_files = {'names_20200815_192922','names_20200815_200606'};
% name_files = {'names_20200815_221847'};
% % name_files = {'names_20200816_091155'};
% name_files = {'names_20200816_130715','names_20200816_153836'};
% % % name_files = {'names_20200818_033732'};
% % % name_files = {'names_20200818_085648','names_20200818_095423','names_20200818_110413'};
% % name_files = {'names_20200818_110413'};
% % name_files = {'names_20200819_122805','names_20200819_124608'};
% % name_files = {'names_20200820_210526','names_20200820_214449'};
% % name_files = {'names_20200820_232100','names_20200821_000452'};
% % % name_files = {'names_20200821_034424'};
% % name_files = {'names_20200821_082021','names_20200821_090015'};
% % 
% % name_files = {'names_20200821_164016','names_20200821_173708'}; 
% % 
% % name_files = {'names_20200822_125421'};
% % name_files = {'names_20200822_182452'};
% % 
% % name_files = {'names_20200822_221625'};
% % name_files = {'names_20200824_071245','names_20200823_235932'};
% % name_files = {'names_20200828_210328'};
% % name_files = {'names_20200804_123325','names_20200801_192140'};
% 
% % name_files = {'names_20200823_235932'};
% name_files = {'names_20200831_105117'};
% name_files = {'names_20200831_161003','names_20200831_194551'};
% 
% name_files = {'names_20200831_234709'};
% 
% name_files = {'names_20200901_065049'};
% name_files = {'names_20200902_093116','names_20200902_102253','names_20200902_110007'};
% name_files = {'names_20200902_113610'};
% name_files = {'names_20200902_213032'};
% name_files = {'names_20200903_221728'};
% 
% name_files = {'names_20200907_214746','names_20200907_232717'};
% name_files = {'names_20200909_002730'};
% name_files = {'names_20200914_105340'};
% name_files = {'names_20200914_154515','names_20200914_165533'};
% name_files = {'names_20200916_013945'};
% name_files = {'names_20200917_172959'};
% name_files = {'names_20200917_214729'};
% name_files = {'names_20200921_161513','names_20200921_191032'};
% name_files = {'names_20200921_225553'};
% name_files = {'names_20200926_004245'};
% % name_files = {'names_20200824_071245','names_20200823_235932'};
% name_files = {'names_20200926_184633','names_20200926_163445'};
% % name_files = {'names_20200926_144951','names_20200926_154601','names_20200926_163445'};
% name_files = {'names_20201002_173358'};
% % name_files = {'names_20200929_193728','names_20200929_211813'};
% % name_files = {'names_20200930_080611','names_20200930_121128',};
% % name_files = {'names_20201002_141715','names_20201002_163701'};
% name_files = {'names_20201002_225549','names_20201002_235437'};
% name_files = {'names_20201003_093919'};
% name_files = {'names_20201003_121625'};
% name_files = {'names_20201003_185240'};
% name_files = {'names_20201004_180507','names_20201004_212657'};
% % name_files = {'names_20201005_125408'};
% name_files = {'names_20201006_082659'};
% name_files = {'names_20201006_110806','names_20201006_122928'};
% name_files = {'names_20201009_211347','names_20201009_220232'};
% name_files = {'names_20201010_002322','names_20201010_015405','names_20201010_022516'};
% name_files = {'names_20201010_152109'};
% name_files = {'names_20201011_183007','names_20201011_193756'};
% name_files = {'names_20200728_130914'};
% name_files = {'names_20201103_000911'};
name_files = {'names_20200802_102035'};
name_files = {'names_20200802_211717'};

% datadir = '\\rcnfs01.rc.fas.harvard.edu\ni_lab\NaCs1pt5\Data\';%'C:\NaCs1pt5_Data_temp\Data\';
% datadir = 'C:\NaCs1pt5_Data_temp\Data\';
datadir = 'C:\Users\willc\Documents\ni_lab\nacs_simulation\data\';

offset = 0;325130e9;
% offset = 0;%l472000.00*1e9;
scale = 1e6;
bPlotOffset = 0;

fit_boo = 0;
% guess = [-0.1 0.3 249.65 0.6]; %Fit param guess, [amp, width, position, offset]
guess = [-0.3 90 -490 0.6]; %Fit param guess, [amp, width, position, offset]

chops = 1;
namefiles = {};

for i = 1:numel(name_files)
    %     [datadir name_files{i}(7:14) '\' name_files{i} '.mat']
    names(i).names = load([datadir name_files{i}(7:14) '\' name_files{i} '.mat']).names;
end
nameFiles = cat(2,names.names);
% nameFiles(3) = [];%Remember to delete later!!

% if isfield(names,'wmFreq')
%     wmFreqs = cat(2,names.wmFreq);
% end

% nameFiles = names.names;


N = size(nameFiles,2);
freqs = zeros(1,N);
survivals = zeros(7,N,chops);
survivals_errs = zeros(7,N,chops);
freqs = [];
offsets = [];


for i = 1:N
    
    loaddat =  load([datadir, nameFiles{i}(1:8),'\', 'data_', nameFiles{i},'.mat']); % load(FindDataFile(nameFiles{i})); % load([datadir{j},'data_', nameFiles{i},'.mat']);
%     try
        survivals(:,i,:) = permute(loaddat.Analysis.SurvivalProbability,[1 3 2]);
        survivals_errs(:,i,:) = permute(loaddat.Analysis.SurvivalProbabilityErr,[1 3 2]);
%     catch
%         disp(['error loading file ' nameFiles{i}]);
%         survivals(:,i,:) = nan;
%         survivals_errs(:,i,:) = nan;
%     end
    scgrp = ScanGroup.load(loaddat.Scan.ScanGroup);
    if ~bPlotOffset
        try
            offsets(i) = scgrp.get_fixed(1).nacs.pa.fOffset;
            freqs(i) = offsets(i) + scgrp.get_fixed(1).nacs.pa.freq; %472167.7*1e9;
        catch
            warning('No offset specified in scangroup, using frequency')
            freqs(i) = scgrp.get_fixed(1).nacs.pa.freq;
        end
    else
        freqs(i) = scgrp.get_fixed(1).nacs.pa.freq;
    end
    
    if survivals(5,i) < 0.5
        print(nameFiles{i})
        break
    end
end

%%Plot only part of scan
cutoff = length(freqs); 11;
freqs = freqs(1:cutoff);
survivals = survivals(:,1:cutoff,:);
survivals_errs = survivals_errs(:,1:cutoff,:);

%% sort
[freqs,order] = sort(freqs);
survivals = survivals(:,order,:);
survivals_errs = survivals_errs(:,order,:);
if ~isempty(offsets)
    offsets = offsets(order);
end

%% hack horizontal axis
% freqs = (472175.2*1e9 + [-700:25:-100]*1e6) ;

%% fit
if fit_boo
    lineshape_fun =@(b,x) b(1)./(1+((x - b(3))/(b(2)/2)).^2) + b(4);
    %     lineshape_fun =@(b,x) 1 - (b(1)*(b(2)/2)^2./((x - b(3)).^2 + (b(2)/2)^2) + b(4));
    x = (freqs(:)-offset)'/scale;
    x_fit = linspace(min(x),max(x),1e3);
    for i = 1:size(survivals,3)
        y = survivals(3,:,i);
        dy = survivals_errs(3,:,i);
        [fitparams(i,:),~,~,s] = nlinfit(x,y,lineshape_fun,guess,'weights',dy.^-2);
        fit_err(i,:) = sqrt(diag(s))';
        y_fit(i,:) = lineshape_fun(fitparams(i,:),x_fit);
%         y_fit(i,:) = lineshape_fun(guess,x_fit);
    end
end

% % freqs = [307878:0.25:307884];
% freqs = 306781 + [0:1:N-1];
% freqs = [80,160]*1e6;
%%

figure(8)
clf;
hold on;
box on;
t = {'Na','Cs','Na + Cs'};
% freqs = [100:10:130,145:25:220]*1e6;

for j = 3
%     subplot(1,3,j);
    hold on;
    box on;
    for i = 1:size(survivals,3)
        errorbar((freqs' - offset)/scale, survivals(j,:,i)',survivals_errs(j,:,i)','.-','markersize',10,'DisplayName',t{j});
%         errorbar((freqs')/scale, survivals(j,:,i)',survivals_errs(j,:,i)','.-');
    end
    title(t{j});

    grid on
    ylabel('Survival');
    xlabel([num2str(offset/scale),' + xxx (MHz)']);
end
% legend
lg = findobj(gca, '-not', 'DisplayName', '', 'type', 'line', '-or', 'type', 'errorbar');
legend(lg,'location','best')
% legend('Na','Cs','Na+Cs')


if fit_boo
    for i = 1:size(survivals,3)
        plot(x_fit,y_fit(i,:),'-k')
        erstr = errstr(fitparams(i,:),fit_err(i,:));
%         text(fitparams(3),0.4,num2str(fitparams))
        text(fitparams(i,3) + 30*i - 40,0.7,sprintf('%s\n',erstr{:}))
    end
end

% errorbar(repmat(freqs,3,1)' - offset, survivals(1:3,:,2)',survivals_errs(1:3,:,2)','o-');
hold off;
% legend({'Na','Cs','Na + Cs'},'location','best');
% title('2-body survival');
% legend({'B2 = -1.8 G', 'B2 = -0.3 G'})
if chops > 1
%     legend('no back','back','no back','back')
%     legend('no drop','drop odt')
end
% ylim([0.3 0.9])

% ylabel('Survival');

figure(9)
clf;
hold on;
box on;
for i = 1:size(survivals,3)
    errorbar((repmat(freqs,2,1)' - offset)/scale, survivals(4:5,:,i)',survivals_errs(4:5,:,i)','.-');
    %     errorbar((repmat(freqs,2,1)')/scale, survivals(4:5,:,i)',survivals_errs(4:5,:,i)','.-');
end
hold off;
legend({'Na','Cs'},'location','se');
title('1-body survival');
ylabel('Survival');
xlabel([num2str(offset/scale),' + xxx (MHz)']);
ylim([0 1])


drawnow();

%%

% 
% xx = -(freqs)/1e6;
% yy = survivals(3,:);
% yye = survivals_errs(3,:);
% 
% lineshape_fun =@(b,x) 1 - (b(1)*(b(2)/2)^2./((x - b(3)).^2 + (b(2)/2)^2) + b(4));
% % guess = [1 1 647.2 0.5];
% guess = [0.25 110 500 0.5];
% [fitparams,~,~,s] = nlinfit(xx,yy,lineshape_fun,guess);
% fit_err = sqrt(diag(s))';
% xx_fit = linspace(min(xx),max(xx),1e3);
% yy_fit = lineshape_fun(fitparams,xx_fit);

% figure(33); clf
% errorbar(xx,yy,yye);
% hold on;
% plot(xx_fit, yy_fit);
% text(550,0.78,num2str(fitparams))
% xlim([min(xx), max(xx)])
% grid on
% ylabel('survival probability')
% % xlabel('xxx [MHz]')
